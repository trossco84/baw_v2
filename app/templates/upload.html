{% extends "base.html" %}

{% block content %}
<div class="wrap">
  <div class="title">
    <h1>Upload Weekly Data</h1>
    <span class="sub"><a href="/" style="color:var(--blue)">← Back to Dashboard</a></span>
  </div>

  <div class="card" style="max-width: 600px;">
    <h3>Import Excel Export from nojuice.ag</h3>

    <form id="uploadForm" style="margin-top: 20px;">
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: var(--muted); font-size: 13px;">
          Select Weekly Admin Export (.xlsx or .xls)
        </label>
        <input
          type="file"
          id="fileInput"
          accept=".xlsx,.xls"
          required
          style="
            display: block;
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,.06);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
          "
        />
      </div>

      <button
        type="submit"
        id="uploadBtn"
        style="
          width: 100%;
          padding: 12px 16px;
          background: var(--blue);
          color: #000;
          border: none;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: opacity 0.2s;
        "
        onmouseover="this.style.opacity='0.8'"
        onmouseout="this.style.opacity='1'"
      >
        Upload & Process
      </button>
    </form>

    <div id="status" style="margin-top: 20px; display: none;">
      <div id="statusMessage" style="padding: 12px; border-radius: 10px; font-size: 13px;"></div>
    </div>
  </div>

  <div class="card" style="max-width: 600px; margin-top: 20px;">
    <h3>Instructions</h3>
    <ul style="color: var(--muted); font-size: 13px; line-height: 1.8; margin: 10px 0; padding-left: 20px;">
      <li>Go to nojuice.ag admin panel and navigate to "Last Week" data</li>
      <li>Export the weekly report as Excel (.xlsx)</li>
      <li>Upload the file using the form above</li>
      <li>The system will automatically parse player data and update the database</li>
      <li>If the week already exists, data will be updated (overwritten)</li>
      <li>After upload, return to the dashboard to view and adjust data</li>
    </ul>
  </div>
</div>

<script>
  const form = document.getElementById('uploadForm');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const status = document.getElementById('status');
  const statusMessage = document.getElementById('statusMessage');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = fileInput.files[0];
    if (!file) {
      showStatus('Please select a file', 'error');
      return;
    }

    // Disable button and show loading
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Processing...';
    showStatus('Uploading and processing file...', 'loading');

    // Create form data
    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/upload/weekly', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok && result.success) {
        showStatus(
          `✓ ${result.message}<br><small>Week: ${result.week_id} | Players: ${result.players_imported}</small>`,
          'success'
        );

        // Reset form
        form.reset();

        // Redirect to dashboard after 2 seconds
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      } else {
        showStatus(`✗ Error: ${result.detail || result.error || 'Upload failed'}`, 'error');
      }
    } catch (error) {
      showStatus(`✗ Network error: ${error.message}`, 'error');
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload & Process';
    }
  });

  function showStatus(message, type) {
    status.style.display = 'block';
    statusMessage.innerHTML = message;

    if (type === 'success') {
      statusMessage.style.background = 'rgba(48,209,88,.12)';
      statusMessage.style.border = '1px solid rgba(48,209,88,.25)';
      statusMessage.style.color = 'var(--green)';
    } else if (type === 'error') {
      statusMessage.style.background = 'rgba(255,69,58,.12)';
      statusMessage.style.border = '1px solid rgba(255,69,58,.25)';
      statusMessage.style.color = 'var(--red)';
    } else {
      statusMessage.style.background = 'rgba(100,210,255,.12)';
      statusMessage.style.border = '1px solid rgba(100,210,255,.25)';
      statusMessage.style.color = 'var(--blue)';
    }
  }
</script>
{% endblock %}